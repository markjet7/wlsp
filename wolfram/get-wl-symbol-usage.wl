(* ::Package:: *)

privateReplacements=FromCharacterCode/@<|"\[LeftAssociation]"->{60,124},"\[RightAssociation]"->{124,62},"\[Shah]"->{1064},"\[TwoWayRule]"->{8596},"\[FreeformPrompt]"->{91,61,93},"\[WolframAlphaPrompt]"->{123,61,125},"\[InvisibleSpace]"->{8203},"\[Piecewise]"->{123},"\[IndentingNewLine]"->{10},"\[SystemsModelDelay]"->{955},"\[Continuation]"->{8945},"\[RoundSpaceIndicator]"->{9251},"\[InvisiblePrefixScriptBase]"->{8203},"\[InvisiblePostfixScriptBase]"->{8203},"\[EntityStart]"->{91,38,124},"\[EntityEnd]"->{124,59,93},"\[SpanFromLeft]"->{8943},"\[SpanFromAbove]"->{8942},"\[SpanFromBoth]"->{8945},"\[Transpose]"->{7488},"\[Conjugate]"->{42},"\[ConjugateTranspose]"->{8224},"\[StepperRight]"->{8594},"\[StepperLeft]"->{8592},"\[StepperUp]"->{8593},"\[StepperDown]"->{8595},"\[HermitianConjugate]"->{7476},"\[VerticalBar]"->{124},"\[NotVerticalBar]"->{8740},"\[Distributed]"->{8776},"\[Conditioned]"->{10632},"\[Gradient]"->{8711},"\[Divergence]"->{8711,46},"\[Curl]"->{8711,120},"\[ContinuedFractionK]"->{75},"\[TensorProduct]"->{8855},"\[TensorWedge]"->{8743},"\[ProbabilityPr]"->{80,114},"\[ExpectationE]"->{69,120},"\[PermutationProduct]"->{8857},"\[Earth]"->{8853},"\[Equal]"->{10869},"\[VerticalSeparator]"->{124},"\[VectorGreater]"->{8827},"\[VectorGreaterEqual]"->{10928},"\[VectorLess]"->{8826},"\[VectorLessEqual]"->{10927},"\[Limit]"->{108,105,109},"\[MaxLimit]"->{108,105,109},"\[MinLimit]"->{108,105,109},"\[Cross]"->{215},"\[Function]"->{10236},"\[DiscreteShift]"->{120666},"\[DifferenceDelta]"->{120665},"\[DiscreteRatio]"->{120679},"\[RuleDelayed]"->{10740},"\[Square]"->{9633},"\[Rule]"->{8594},"\[Implies]"->{8658},"\[ShortRightArrow]"->{8594},"\[ShortLeftArrow]"->{8592},"\[SelectionPlaceholder]"->{9632},"\[Placeholder]"->{9633},"\[ShortUpArrow]"->{8593},"\[ShortDownArrow]"->{8595},"\[Application]"->{8226},"\[LeftBracketingBar]"->{124},"\[RightBracketingBar]"->{124},"\[LeftDoubleBracketingBar]"->{124,124},"\[RightDoubleBracketingBar]"->{124,124},"\[ScriptA]"->{119990},"\[ScriptB]"->{119991},"\[ScriptC]"->{119992},"\[ScriptD]"->{119993},"\[ScriptF]"->{119995},"\[ScriptH]"->{119997},"\[ScriptI]"->{119998},"\[ScriptJ]"->{119999},"\[ScriptK]"->{120000},"\[ScriptM]"->{120002},"\[ScriptN]"->{120003},"\[ScriptP]"->{120005},"\[ScriptQ]"->{120006},"\[ScriptR]"->{120007},"\[ScriptS]"->{120008},"\[ScriptT]"->{120009},"\[ScriptU]"->{120010},"\[ScriptV]"->{120011},"\[ScriptW]"->{120012},"\[ScriptX]"->{120013},"\[ScriptY]"->{120014},"\[ScriptZ]"->{120015},"\[GothicA]"->{120094},"\[GothicB]"->{120095},"\[GothicC]"->{120096},"\[GothicD]"->{120097},"\[GothicE]"->{120098},"\[GothicF]"->{120099},"\[GothicG]"->{120100},"\[GothicH]"->{120101},"\[GothicI]"->{120102},"\[GothicJ]"->{120103},"\[GothicK]"->{120104},"\[GothicL]"->{120105},"\[GothicM]"->{120106},"\[GothicN]"->{120107},"\[GothicO]"->{120108},"\[GothicP]"->{120109},"\[GothicQ]"->{120110},"\[GothicR]"->{120111},"\[GothicS]"->{120112},"\[GothicT]"->{120113},"\[GothicU]"->{120114},"\[GothicV]"->{120115},"\[GothicW]"->{120116},"\[GothicX]"->{120117},"\[GothicY]"->{120118},"\[GothicZ]"->{120119},"\[DoubleStruckA]"->{120146},"\[DoubleStruckB]"->{120147},"\[DoubleStruckC]"->{120148},"\[DoubleStruckD]"->{120149},"\[DoubleStruckE]"->{120150},"\[DoubleStruckF]"->{120151},"\[DoubleStruckG]"->{120152},"\[DoubleStruckH]"->{120153},"\[DoubleStruckI]"->{120154},"\[DoubleStruckJ]"->{120155},"\[DoubleStruckK]"->{120156},"\[DoubleStruckL]"->{120157},"\[DoubleStruckM]"->{120158},"\[DoubleStruckN]"->{120159},"\[DoubleStruckO]"->{120160},"\[DoubleStruckP]"->{120161},"\[DoubleStruckQ]"->{120162},"\[DoubleStruckR]"->{120163},"\[DoubleStruckS]"->{120164},"\[DoubleStruckT]"->{120165},"\[DoubleStruckU]"->{120166},"\[DoubleStruckV]"->{120167},"\[DoubleStruckW]"->{120168},"\[DoubleStruckX]"->{120169},"\[DoubleStruckY]"->{120170},"\[DoubleStruckZ]"->{120171},"\[DotlessJ]"->{567},"\[LightBulb]"->{128161},"\[NumberSign]"->{35},"\[WarningSign]"->{9888},"\[ScriptDotlessI]"->{120484},"\[ScriptDotlessJ]"->{120229},"\[DoubledPi]"->{8508},"\[DoubledGamma]"->{8509},"\[CapitalDifferentialD]"->{120123},"\[DifferentialD]"->{120149},"\[ExponentialE]"->{120150},"\[ImaginaryI]"->{120154},"\[ImaginaryJ]"->{120155},"\[FilledSmallCircle]"->{9679},"\[DottedSquare]"->{11034},"\[GraySquare]"->{9724},"\[GrayCircle]"->{9679},"\[LetterSpace]"->{95},"\[TripleDot]"->{8230},"\[SystemEnterKey]"->{91,69,78,84,69,82,93},"\[LeftSkeleton]"->{8810},"\[RightSkeleton]"->{8811},"\[ControlKey]"->{91,67,84,82,76,93},"\[AliasDelimiter]"->{8285},"\[InvisibleComma]"->{8203},"\[ReturnKey]"->{91,82,69,84,93},"\[AliasIndicator]"->{8285},"\[EscapeKey]"->{91,69,83,67,93},"\[CommandKey]"->{91,67,77,68,93},"\[InvisibleApplication]"->{8203},"\[ScriptCapitalA]"->{119964},"\[ScriptCapitalC]"->{119966},"\[ScriptCapitalD]"->{119967},"\[ScriptCapitalG]"->{119970},"\[ScriptCapitalJ]"->{119973},"\[ScriptCapitalK]"->{119974},"\[ScriptCapitalN]"->{119977},"\[ScriptCapitalO]"->{119978},"\[ScriptCapitalP]"->{119979},"\[ScriptCapitalQ]"->{119980},"\[ScriptCapitalS]"->{119982},"\[ScriptCapitalT]"->{119983},"\[ScriptCapitalU]"->{119984},"\[ScriptCapitalV]"->{119985},"\[ScriptCapitalW]"->{119986},"\[ScriptCapitalX]"->{119987},"\[ScriptCapitalY]"->{119988},"\[ScriptCapitalZ]"->{119989},"\[GothicCapitalA]"->{120068},"\[GothicCapitalB]"->{120069},"\[GothicCapitalD]"->{120071},"\[GothicCapitalE]"->{120072},"\[GothicCapitalF]"->{120073},"\[GothicCapitalG]"->{120074},"\[GothicCapitalJ]"->{120077},"\[GothicCapitalK]"->{120078},"\[GothicCapitalL]"->{120079},"\[GothicCapitalM]"->{120080},"\[GothicCapitalN]"->{120081},"\[GothicCapitalO]"->{120082},"\[GothicCapitalP]"->{120083},"\[GothicCapitalQ]"->{120084},"\[GothicCapitalS]"->{120086},"\[GothicCapitalT]"->{120087},"\[GothicCapitalU]"->{120088},"\[GothicCapitalV]"->{120089},"\[GothicCapitalW]"->{120090},"\[GothicCapitalX]"->{120091},"\[GothicCapitalY]"->{120092},"\[DoubleStruckCapitalA]"->{120120},"\[DoubleStruckCapitalB]"->{120121},"\[DoubleStruckCapitalC]"->{8450},"\[DoubleStruckCapitalD]"->{120123},"\[DoubleStruckCapitalE]"->{120124},"\[DoubleStruckCapitalF]"->{120125},"\[DoubleStruckCapitalG]"->{120126},"\[DoubleStruckCapitalH]"->{8461},"\[DoubleStruckCapitalI]"->{120128},"\[DoubleStruckCapitalJ]"->{120129},"\[DoubleStruckCapitalK]"->{120130},"\[DoubleStruckCapitalL]"->{120131},"\[DoubleStruckCapitalM]"->{120132},"\[DoubleStruckCapitalN]"->{8469},"\[DoubleStruckCapitalO]"->{120134},"\[DoubleStruckCapitalP]"->{8473},"\[DoubleStruckCapitalQ]"->{8474},"\[DoubleStruckCapitalR]"->{8477},"\[DoubleStruckCapitalS]"->{120138},"\[DoubleStruckCapitalT]"->{120139},"\[DoubleStruckCapitalU]"->{120140},"\[DoubleStruckCapitalV]"->{120141},"\[DoubleStruckCapitalW]"->{120142},"\[DoubleStruckCapitalX]"->{120143},"\[DoubleStruckCapitalY]"->{120144},"\[DoubleStruckCapitalZ]"->{8484},"\[TabKey]"->{91,84,65,66,93},"\[SpaceKey]"->{91,83,80,65,67,69,93},"\[DeleteKey]"->{91,68,69,76,93},"\[AltKey]"->{91,65,76,84,93},"\[OptionKey]"->{91,79,80,84,73,79,78,93},"\[KeyBar]"->{65112},"\[EnterKey]"->{91,69,78,84,69,82,93},"\[ShiftKey]"->{91,83,72,73,70,84,93},"\[Mod1Key]"->{91,77,79,68,49,93},"\[Mod2Key]"->{91,77,79,68,50,93},"\[LongEqual]"->{10869},"\[ConstantC]"->{120148},"\[DoubleStruckZero]"->{120792},"\[DoubleStruckOne]"->{120793},"\[DoubleStruckTwo]"->{120794},"\[DoubleStruckThree]"->{120795},"\[DoubleStruckFour]"->{120796},"\[DoubleStruckFive]"->{120797},"\[DoubleStruckSix]"->{120798},"\[DoubleStruckSeven]"->{120799},"\[DoubleStruckEight]"->{120800},"\[DoubleStruckNine]"->{120801},"\[GothicZero]"->{48},"\[GothicOne]"->{49},"\[GothicTwo]"->{50},"\[GothicThree]"->{51},"\[GothicFour]"->{52},"\[GothicFive]"->{53},"\[GothicSix]"->{54},"\[GothicSeven]"->{55},"\[GothicEight]"->{56},"\[GothicNine]"->{57},"\[ScriptZero]"->{48},"\[ScriptOne]"->{49},"\[ScriptTwo]"->{50},"\[ScriptThree]"->{51},"\[ScriptFour]"->{52},"\[ScriptFive]"->{53},"\[ScriptSix]"->{54},"\[ScriptSeven]"->{55},"\[ScriptEight]"->{56},"\[ScriptNine]"->{57},"\[NumberComma]"->{44}|>;
specialCharacterTable=Normal[privateReplacements];
superscriptTable=Thread[Characters["0123456789+-=()abcdefghijklmnoprstuvwxyz"]->Characters["\:2070\.b9\.b2\.b3\:2074\:2075\:2076\:2077\:2078\:2079\:207a\:207b\:207c\:207d\:207e\:1d43\:1d47\:1d9c\:1d48\:1d49\:1da0\:1d4d\:02b0\:2071\:02b2\:1d4f\:02e1\:1d50\:207f\:1d52\:1d56\:02b3\:02e2\:1d57\:1d58\:1d5b\:02b7\:02e3\:02b8\:1dbb"]];
subscriptTable=Thread[Characters["0123456789+-=()aehijklmnoprstuvx"]->Characters["\:2080\:2081\:2082\:2083\:2084\:2085\:2086\:2087\:2088\:2089\:208a\:208b\:208c\:208d\:208e\:2090\:2091\:2095\:1d62\:2c7c\:2096\:2097\:2098\:2099\:2092\:209a\:1d63\:209b\:209c\:1d64\:1d65\:2093"]];
markdownEscapeTable=(x:Characters["\\`*_#+-<>"]):>("\\"<>x);


parseRules={s_String:>MathLink`CallFrontEnd[FrontEnd`UndocumentedTestFEParserPacket[If[StringMatchQ[s,"\"*\""],ToExpression[s],s],False]][[1,1]]};
parseUsage[str_]:=If[#[[-1]]===#[[-2]],#[[-1]],AppendTo[$problematicBox,str];"cannot be parsed"]&@NestWhileList[(#/.parseRules)&,str,UnsameQ,2,10];
toSuperscript[str_String]:=StringReplace[str,superscriptTable];
toSubscript[str_String]:=StringReplace[str,subscriptTable];


ClearAll[renderUsage]
renderUsage[RowBox[list_]]:=StringJoin[renderUsage/@list];
renderUsage[str_String]:=StringReplace[StringReplace[str,specialCharacterTable],markdownEscapeTable];
renderUsage[StyleBox[str_,a___,ShowStringCharacters->True,___]]:=StringJoin["\"",renderUsage@StyleBox[str,a],"\""];
renderUsage[StyleBox[str_,"TI",___]]:=StringJoin["*",renderUsage@str,"*"];
renderUsage[StyleBox[str_,___]]:=renderUsage@str;
renderUsage[x:(_Integer|_Real)]:=ToString[x];
renderUsage[SubscriptBox[x_,y_,___]]:=StringJoin[renderUsage@x,toSubscript@renderUsage@y];
renderUsage[SuperscriptBox[x_,y_,___]]:=StringJoin[renderUsage@x,toSuperscript@renderUsage@y];
renderUsage[SubsuperscriptBox[x_,y_,z_,___]]:=StringJoin[renderUsage@x,toSubscript@renderUsage@y,toSuperscript@renderUsage@z];
renderUsage[UnderscriptBox[x_,y_,___]]:=renderUsage[SubscriptBox[x,y]];
renderUsage[OverscriptBox[x_,y_,___]]:=renderUsage[SuperscriptBox[x,y]];
renderUsage[UnderoverscriptBox[x_,y_,z_,___]]:=renderUsage[SubsuperscriptBox[x,y,z]];
renderUsage[FractionBox[x_,y_,___]]:=StringJoin[toSuperscript@renderUsage@x,"/",toSubscript@renderUsage@y];
renderUsage[GridBox[{{x_},{y_}}]]:=StringJoin[toSuperscript@renderUsage@x,toSubscript@renderUsage@y];
renderUsage[CheckboxBox[True]|CheckboxBox[x_,{x_,___}]]:="\[CheckmarkedBox]";
renderUsage[CheckboxBox[False]|CheckboxBox[x_,{_,x_,___}]]:="\:2610";
renderUsage[CheckboxBox[___]]:="\[CheckedBox]";
renderUsage[RadioButtonBox[x_,x_|{___,x_,___}]]:="\:25c9";
renderUsage[RadioButtonBox[___]]:="\:25ce";
renderUsage[SqrtBox[x_,___]]:="\[Sqrt]"<>renderUsage[x];
renderUsage[RadicalBox[x_,y_,___]]:=renderUsage[y]<>"\[Sqrt]"<>renderUsage[x];
renderUsage[box_TemplateBox]:=renderUsage[BoxForm`TemplateBoxToDisplayBoxes[box]];
renderUsage[FormBox[x_,___]]:=renderUsage[x];
renderUsage[TooltipBox[x_,___]]:=renderUsage[x];
renderUsage[TagBox[x_,___]]:=renderUsage[x];
renderUsage[Cell[_[x_,___],___]]:=renderUsage[x];
renderUsage[any_]:=(AppendTo[$problematicBox,any];ToString[any]);


fixContinuousItalic[rendered_]:=StringReplace[rendered,RegularExpression["(?<!\\\\)\\*\\*"]->""];
decorateUsageBold[rendered_]:=StringReplace[rendered,RegularExpression["^([$A-Za-z0-9]*(?:\\[[^\\[\\]]*(?:\\[[^\\[\\]]*\\][^\\[\\]]*)*\\])?)(.*)"]->"<b>$1</b>$2"];
toJSON[a_]:=StringRiffle[KeyValueMap["\""<>#1<>"\":"<>Switch[Head[#2],String,"\""<>StringReplace[#2,{"\""->"\\\"","\\"->"\\\\","\n"->"\\n","\t"->"\\t"}]<>"\"",Integer,ToString[#2],Real,ToString[10#1]<>"e"<>ToString[#2-1]&@@MantissaExponent[#2],_,Echo[#2];Abort[]]&,a],{"{",",","}"}];


wlNames=WolframLanguageData["EntityCanonicalNames"];
wlData=WolframLanguageData[wlNames,{"Name","VersionIntroduced","Ranks","URL","TypesetUsage"}];


$problematicBox={};
wlDataLength=Length[wlData];
Monitor[wlUsagesStr=Table[
  (fixContinuousItalic@*renderUsage@*parseUsage/@#[[1,1,;;,1]])&@wlData[[i,5]],
  {i,1,wlDataLength}
];,i];


Unprotect[SyntaxInformation];
SetAttributes[SyntaxInformation,HoldAllComplete];
wlSymbolSyntax=ToExpression[TemplateApply["Quiet@SyntaxInformation[``]",#]]&/@wlData;
ClearAttributes[SyntaxInformation,HoldAllComplete];
Protect[SyntaxInformation];


wlTypeStr=MapThread[
  Which[
    !FreeQ[#2,"ArgumentsPattern"],"function",
    TrueQ@ToExpression[TemplateApply["Quiet@MemoryConstrained[`1`,1]===`1`",#1[[1]]]],"keyword",
    True,"constant"]&,
  {wlData,wlSymbolSyntax},1];


wlUsagesDecoratedStr=Map[decorateUsageBold,wlUsagesStr,{2}];
wlDataStr=Table[<|"name"->#1,"type"->wlTypeStr[[i]],"version"->#2,"rank"->If[MissingQ[#3],99999,"All"/.#3],"url"->#4[[1]],"usage"->StringRiffle[wlUsagesDecoratedStr[[i]],"\n\n---\n"]|>&@@wlData[[i]],{i,1,Length@wlData}];
wlSymbolUsagesText=StringRiffle[toJSON/@wlDataStr[[;;]],"\n"];


stream=OpenWrite[NotebookDirectory[]<>"/wl-symbol-usages.txt",BinaryFormat->True];
BinaryWrite[stream,StringToByteArray[wlSymbolUsagesText,"UTF-8"]];
Close[stream];
